@model PEngineV.Models.PostReadViewModel
@inject Microsoft.Extensions.Localization.IStringLocalizer<PEngineV.SharedResource> L
@{
    ViewData["Title"] = Model.Post.Title;
}

<div class="pe-breadcrumb">
    <a asp-controller="Home" asp-action="Index">@L["Nav_Home"]</a>
    <span class="pe-breadcrumb-sep">/</span>
    @if (!string.IsNullOrEmpty(Model.Post.Category))
    {
        <a asp-controller="Post" asp-action="List">posts</a>
        <span class="pe-breadcrumb-sep">/</span>
        <a asp-controller="Post" asp-action="List" asp-route-category="@Model.Post.Category">@Model.Post.Category</a>
        <span class="pe-breadcrumb-sep">/</span>
    }
    else
    {
        <a asp-controller="Post" asp-action="List">posts</a>
        <span class="pe-breadcrumb-sep">/</span>
    }
    <span class="pe-breadcrumb-current">@Model.Post.Title</span>
</div>

<div class="pe-panel">
    <div class="pe-panel-header">
        <i class="fa-solid fa-file-lines pe-panel-icon"></i>
        @Model.Post.Title
        @if (Model.IsOwner)
        {
            <a class="pe-btn-link pe-ml-auto" asp-controller="Post" asp-action="Edit" asp-route-id="@Model.Post.Id">
                <i class="fa-solid fa-pen"></i>
            </a>
            <a class="pe-btn-link" asp-controller="Post" asp-action="Delete" asp-route-id="@Model.Post.Id">
                <i class="fa-solid fa-trash"></i>
            </a>
        }
    </div>
    <div class="pe-panel-body">
        <div class="pe-post-meta pe-mb-2">
            @if (!string.IsNullOrEmpty(Model.Post.Category))
            {
                <span class="pe-badge pe-badge-category">@Model.Post.Category</span>
            }
            @L["Post_By"] @if (Model.Post.AuthorUsername is not null) {<a asp-controller="Profile" asp-action="Index" asp-route-username="@Model.Post.AuthorUsername" class="pe-author-link">@Model.Post.Author</a>} else {@Model.Post.Author} &middot; @L["Post_PublishedOn"] @Model.Post.PublishedAt.ToString("yyyy-MM-dd")
            @if (Model.Post.Visibility is not null && Model.Post.Visibility != "Public")
            {
                <span class="pe-badge">@Model.Post.Visibility</span>
            }
        </div>
        @if (Model.Series is not null)
        {
            <div class="pe-post-series-info pe-mb-2">
                <div class="pe-post-series-header">
                    <i class="fa-solid fa-book"></i>
                    <strong>@L["Series_Label"]:</strong>
                    <span>@Model.Series.Name</span>
                    @if (Model.SeriesOrder > 0)
                    {
                        <span class="pe-badge">Part @Model.SeriesOrder</span>
                    }
                </div>
                @if (Model.Series.Posts?.Any() == true)
                {
                    <ol class="pe-series-posts-list">
                        @foreach (var seriesPost in Model.Series.Posts)
                        {
                            <li class="@(seriesPost.IsCurrent ? "pe-series-post-current" : "")">
                                @if (seriesPost.IsCurrent)
                                {
                                    <span class="pe-series-post-title">@seriesPost.Title</span>
                                    <span class="pe-series-post-badge">@L["Series_CurrentPost"]</span>
                                }
                                else
                                {
                                    <a asp-controller="Post" asp-action="Read" asp-route-id="@seriesPost.Id">
                                        @seriesPost.Title
                                    </a>
                                }
                            </li>
                        }
                    </ol>
                }
            </div>
        }
        <div class="pe-post-content">@Html.Raw(Model.Post.Content)</div>
    </div>
</div>

@if (Model.Citations?.Any() == true)
{
    <div class="pe-panel pe-mt-3">
        <div class="pe-panel-header">
            <i class="fa-solid fa-quote-left pe-panel-icon"></i>
            @L["Citations_Title"]
        </div>
        <div class="pe-panel-body">
            <ol class="pe-citations-list">
                @for (int i = 0; i < Model.Citations.Count(); i++)
                {
                    var citation = Model.Citations.ElementAt(i);
                    <li id="citation-@(i + 1)">
                        @if (!string.IsNullOrEmpty(citation.Author))
                        {
                            <span class="pe-citation-meta">@citation.Author. </span>
                        }
                        @if (citation.PublicationDate.HasValue)
                        {
                            <span class="pe-citation-meta">(@citation.PublicationDate.Value.ToString("yyyy")). </span>
                        }
                        <span class="pe-citation-title">@citation.Title</span><span class="pe-citation-meta">. </span>
                        @if (!string.IsNullOrEmpty(citation.Publisher))
                        {
                            <span class="pe-citation-meta">@citation.Publisher. </span>
                        }
                        @if (!string.IsNullOrEmpty(citation.Url))
                        {
                            <span class="pe-citation-meta"><a href="@citation.Url" target="_blank" rel="noopener noreferrer">@citation.Url</a></span>
                        }
                        @if (!string.IsNullOrEmpty(citation.Notes))
                        {
                            <span class="pe-citation-notes">@citation.Notes</span>
                        }
                    </li>
                }
            </ol>
        </div>
    </div>
}

@if (Model.Post.Tags?.Any() == true)
{
    <div class="pe-panel pe-mt-3">
        <div class="pe-panel-header">
            <i class="fa-solid fa-tags pe-panel-icon"></i>
            @L["Post_Tags"]
        </div>
        <div class="pe-panel-body">
            <div class="pe-post-tags">
                @foreach (var tag in Model.Post.Tags)
                {
                    <span class="pe-tag">@tag</span>
                }
            </div>
        </div>
    </div>
}

@if (Model.Attachments?.Any() == true)
{
    <div class="pe-panel pe-mt-3">
        <div class="pe-panel-header">
            <i class="fa-solid fa-paperclip pe-panel-icon"></i>
            @L["Post_Attachments"] (@Model.Attachments.Count())
        </div>
        <div class="pe-attachment-list">
            @foreach (var att in Model.Attachments)
            {
                <div class="pe-attachment-item">
                    <a href="@att.DownloadUrl" download="@att.FileName" class="pe-attachment-download-link">
                        <div class="pe-attachment-info">
                            <i class="fa-solid @GetFileIcon(att.FileName) pe-file-icon"></i>
                            <span class="pe-attachment-name">@att.FileName</span>
                            <span class="pe-attachment-meta">@FormatFileSize(att.FileSize)</span>
                            <span class="pe-attachment-hash" title="SHA-256">@att.Sha256Hash[..16]...</span>
                        </div>
                    </a>
                    <button type="button" class="pe-attachment-info-btn"
                            data-filename="@att.FileName"
                            data-contenttype="@att.ContentType"
                            data-filesize="@att.FileSize"
                            data-hash="@att.Sha256Hash"
                            data-download-url="@att.DownloadUrl"
                            title="@L["Attachment_Details"]">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                </div>
            }
        </div>
    </div>
}

<div class="pe-panel pe-mt-3">
    <div class="pe-panel-header">
        <i class="fa-solid fa-comments pe-panel-icon"></i>
        @L["Comment_SectionTitle"] (@Model.Comments.Count())
    </div>
    <div class="pe-panel-body">
        <form method="post" asp-controller="Post" asp-action="Comment">
            <input type="hidden" name="PostId" value="@Model.Post.Id" />
            @if (!Model.IsLoggedIn)
            {
                <div class="pe-form-row">
                    <div class="pe-form-group pe-form-group-inline">
                        <label class="pe-label" for="comment-name">@L["Comment_Field_Name"]</label>
                        <input class="pe-input" type="text" id="comment-name" name="Name" required />
                    </div>
                    <div class="pe-form-group pe-form-group-inline">
                        <label class="pe-label" for="comment-email">@L["Comment_Field_Email"]</label>
                        <input class="pe-input" type="email" id="comment-email" name="Email" />
                    </div>
                    <div class="pe-form-group pe-form-group-inline">
                        <label class="pe-label" for="comment-password">@L["Comment_Field_Password"]</label>
                        <input class="pe-input" type="password" id="comment-password" name="Password" required />
                    </div>
                </div>
            }
            <div class="pe-form-group">
                <label class="pe-label" for="comment-content">@L["Comment_Field_Content"]</label>
                <textarea class="pe-textarea pe-textarea-sm" id="comment-content" name="Content" required></textarea>
            </div>
            <div class="pe-form-row pe-form-row-between">
                <label class="pe-label pe-checkbox-label">
                    <input type="checkbox" name="IsPrivate" value="true" class="pe-checkbox" />
                    @L["Comment_Field_Private"]
                </label>
                <button type="submit" class="pe-btn pe-btn-primary">@L["Comment_Button_Submit"]</button>
            </div>
        </form>
    </div>

    @if (Model.Comments.Any())
    {
        <div class="pe-comment-list">
            @{ await RenderComments(Model.Comments, 0); }
        </div>
    }
    else
    {
        <div class="pe-empty">@L["Comment_NoComments"]</div>
    }
</div>

<div class="pe-overlay" id="file-detail-overlay" hidden>
    <div class="pe-overlay-backdrop"></div>
    <div class="pe-overlay-content">
        <div class="pe-overlay-header">
            <h2 class="pe-overlay-title">@L["Attachment_Details"]</h2>
            <button type="button" class="pe-overlay-close" id="file-detail-close">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="pe-overlay-body">
            <div class="pe-file-detail-grid">
                <div class="pe-file-detail-row">
                    <span class="pe-file-detail-label">@L["Attachment_FileName"]</span>
                    <span class="pe-file-detail-value" id="file-detail-name"></span>
                </div>
                <div class="pe-file-detail-row">
                    <span class="pe-file-detail-label">@L["Attachment_FileType"]</span>
                    <span class="pe-file-detail-value" id="file-detail-type"></span>
                </div>
                <div class="pe-file-detail-row">
                    <span class="pe-file-detail-label">@L["Attachment_FileSize"]</span>
                    <span class="pe-file-detail-value" id="file-detail-size"></span>
                </div>
                <div class="pe-file-detail-row">
                    <span class="pe-file-detail-label">@L["Attachment_Hash"]</span>
                    <span class="pe-file-detail-value pe-file-detail-hash" id="file-detail-hash"></span>
                </div>
            </div>
        </div>
        <div class="pe-overlay-footer">
            <button type="button" class="pe-btn pe-btn-secondary" id="file-detail-verify">
                <i class="fa-solid fa-shield-halved"></i>
                @L["Attachment_Verify"]
            </button>
            <a href="#" class="pe-btn pe-btn-primary" id="file-detail-download" download>
                <i class="fa-solid fa-download"></i>
                @L["Attachment_Download"]
            </a>
            <button type="button" class="pe-btn pe-btn-secondary" id="file-detail-cancel">
                @L["Button_Cancel"]
            </button>
        </div>
    </div>
</div>

<div class="pe-overlay" id="file-verify-overlay" hidden>
    <div class="pe-overlay-backdrop"></div>
    <div class="pe-overlay-content">
        <div class="pe-overlay-header">
            <h2 class="pe-overlay-title">@L["Attachment_Verify_Title"]</h2>
            <button type="button" class="pe-overlay-close" id="file-verify-close">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="pe-overlay-body">
            <div class="pe-verify-section">
                <div class="pe-verify-hash-row">
                    <span class="pe-verify-label">@L["Attachment_Verify_Expected"]:</span>
                    <code class="pe-verify-hash" id="verify-expected-hash"></code>
                </div>
            </div>
            <div class="pe-verify-section">
                <label class="pe-verify-label">@L["Attachment_Verify_SelectFile"]:</label>
                <div class="pe-verify-upload-zone" id="verify-upload-zone">
                    <div class="pe-verify-upload-content">
                        <i class="fa-solid fa-file-arrow-up"></i>
                        <p>@L["Attachment_Verify_SelectPrompt"]</p>
                        <label class="pe-btn pe-btn-secondary pe-btn-sm" for="verify-file-input">
                            @L["Post_Upload_Browse"]
                        </label>
                        <input type="file" id="verify-file-input" class="pe-upload-input" />
                    </div>
                </div>
            </div>
            <div id="verify-progress" class="pe-verify-section" hidden>
                <div class="pe-verify-status">
                    <i class="fa-solid fa-spinner fa-spin"></i>
                    <span id="verify-status-text">@L["Attachment_Verify_Progress"]</span>
                </div>
                <div class="pe-progress-bar">
                    <div class="pe-progress-bar-fill" id="verify-progress-bar"></div>
                </div>
                <div class="pe-progress-text" id="verify-progress-text">0%</div>
            </div>
            <div id="verify-result" class="pe-verify-section" hidden>
                <div class="pe-verify-hash-row">
                    <span class="pe-verify-label">@L["Attachment_Verify_Computed"]:</span>
                    <code class="pe-verify-hash" id="verify-computed-hash"></code>
                </div>
                <div id="verify-success" class="pe-verify-result-box pe-verify-success" hidden>
                    <i class="fa-solid fa-circle-check"></i>
                    <span>@L["Attachment_Verify_Success"]</span>
                </div>
                <div id="verify-failure" class="pe-verify-result-box pe-verify-failure" hidden>
                    <i class="fa-solid fa-circle-xmark"></i>
                    <span>@L["Attachment_Verify_Failure"]</span>
                </div>
            </div>
        </div>
        <div class="pe-overlay-footer">
            <button type="button" class="pe-btn pe-btn-secondary" id="file-verify-back">
                <i class="fa-solid fa-arrow-left"></i>
                @L["Button_Back"]
            </button>
            <button type="button" class="pe-btn pe-btn-secondary" id="file-verify-done">
                @L["Button_Cancel"]
            </button>
        </div>
    </div>
</div>

<div class="pe-overlay" id="comment-delete-overlay" hidden>
    <div class="pe-overlay-backdrop"></div>
    <div class="pe-overlay-content">
        <div class="pe-overlay-header">
            <h2 class="pe-overlay-title">@L["Comment_Delete_Confirm_Title"]</h2>
            <button type="button" class="pe-overlay-close" id="comment-delete-close">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="pe-overlay-body">
            <p>@L["Comment_Delete_Confirm_Message"]</p>
        </div>
        <div class="pe-overlay-footer">
            <button type="button" class="pe-btn pe-btn-danger" id="comment-delete-confirm">
                @L["Button_Delete"]
            </button>
            <button type="button" class="pe-btn pe-btn-secondary" id="comment-delete-cancel">
                @L["Button_Cancel"]
            </button>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/wysiwyg-editor.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/file-detail.js" asp-append-version="true"></script>
    <script src="~/js/comment-actions.js" asp-append-version="true"></script>
    <script src="~/js/citation-refs.js" asp-append-version="true"></script>
}

@functions {
    async Task RenderComments(IEnumerable<CommentViewModel> comments, int depth)
    {
        foreach (var comment in comments)
        {
            var isPrivateHidden = comment.IsPrivate && string.IsNullOrEmpty(comment.Content);
            <div class="pe-comment pe-comment-depth-@(Math.Min(depth, 5)) @(comment.IsPrivate ? "pe-comment-private" : "")">
                <div class="pe-comment-header">
                    <span class="pe-comment-author">@if (comment.AuthorUsername is not null) {<a asp-controller="Profile" asp-action="Index" asp-route-username="@comment.AuthorUsername" class="pe-author-link">@comment.Name</a>} else {@comment.Name}</span>
                    @if (comment.IsPrivate)
                    {
                        <span class="pe-badge">@L["Comment_Badge_Private"]</span>
                    }
                    @if (Model.IsOwner && !string.IsNullOrEmpty(comment.Email))
                    {
                        <span class="pe-comment-email">@comment.Email</span>
                    }
                    <span class="pe-comment-date">@comment.CreatedAt.ToString("yyyy-MM-dd HH:mm")</span>
                </div>
                @if (isPrivateHidden)
                {
                    <div class="pe-comment-content pe-text-muted">@L["Comment_Private_Hidden"]</div>
                }
                else
                {
                    <div class="pe-comment-content">@comment.Content</div>
                }
                <div class="pe-comment-actions">
                    <button type="button" class="pe-btn-link pe-comment-reply-toggle"
                            data-comment-id="@comment.Id">@L["Comment_Button_Reply"]</button>
                    @if (Model.IsOwner)
                    {
                        <form method="post" asp-controller="Post" asp-action="DeleteComment" class="pe-inline-form pe-delete-comment-form">
                            <input type="hidden" name="id" value="@comment.Id" />
                            <input type="hidden" name="postId" value="@Model.Post.Id" />
                            <button type="submit" class="pe-btn-link pe-text-danger">@L["Comment_Button_Delete"]</button>
                        </form>
                    }
                </div>
                <div class="pe-comment-reply-form" id="reply-form-@comment.Id" hidden>
                    <form method="post" asp-controller="Post" asp-action="Comment">
                        <input type="hidden" name="PostId" value="@Model.Post.Id" />
                        <input type="hidden" name="ParentCommentId" value="@comment.Id" />
                        @if (!Model.IsLoggedIn)
                        {
                            <div class="pe-form-row">
                                <div class="pe-form-group pe-form-group-inline">
                                    <input class="pe-input" type="text" name="Name"
                                           placeholder="@L["Comment_Field_Name"]" required />
                                </div>
                                <div class="pe-form-group pe-form-group-inline">
                                    <input class="pe-input" type="email" name="Email"
                                           placeholder="@L["Comment_Field_Email"]" />
                                </div>
                                <div class="pe-form-group pe-form-group-inline">
                                    <input class="pe-input" type="password" name="Password"
                                           placeholder="@L["Comment_Field_Password"]" required />
                                </div>
                            </div>
                        }
                        <div class="pe-form-group">
                            <textarea class="pe-textarea pe-textarea-sm" name="Content"
                                      placeholder="@L["Comment_Reply_Placeholder"]" required></textarea>
                        </div>
                        <div class="pe-form-row pe-form-row-between">
                            <label class="pe-label pe-checkbox-label">
                                <input type="checkbox" name="IsPrivate" value="true" class="pe-checkbox" />
                                @L["Comment_Field_Private"]
                            </label>
                            <button type="submit" class="pe-btn pe-btn-primary pe-btn-sm">@L["Comment_Button_Submit"]</button>
                        </div>
                    </form>
                </div>
                @if (comment.Replies.Any())
                {
                    await RenderComments(comment.Replies, depth + 1);
                }
            </div>
        }
    }

    static string FormatFileSize(long bytes)
    {
        string[] sizes = ["B", "KB", "MB", "GB"];
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    static string GetFileIcon(string fileName)
    {
        var ext = System.IO.Path.GetExtension(fileName).ToLowerInvariant();
        return ext switch
        {
            ".pdf" => "fa-file-pdf",
            ".doc" or ".docx" => "fa-file-word",
            ".xls" or ".xlsx" => "fa-file-excel",
            ".ppt" or ".pptx" => "fa-file-powerpoint",
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" or ".svg" or ".webp" => "fa-file-image",
            ".mp4" or ".avi" or ".mov" or ".wmv" or ".flv" or ".webm" => "fa-file-video",
            ".mp3" or ".wav" or ".flac" or ".aac" or ".ogg" => "fa-file-audio",
            ".zip" or ".rar" or ".7z" or ".tar" or ".gz" => "fa-file-zipper",
            ".txt" or ".md" or ".log" => "fa-file-lines",
            ".js" or ".ts" or ".jsx" or ".tsx" or ".json" => "fa-file-code",
            ".cs" or ".java" or ".py" or ".cpp" or ".c" or ".h" or ".go" or ".rs" => "fa-file-code",
            ".html" or ".css" or ".xml" or ".yml" or ".yaml" => "fa-file-code",
            _ => "fa-file"
        };
    }
}
